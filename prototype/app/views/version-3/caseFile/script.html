<script>
  $(document).ready(function () {
    const SPECIAL_CASE_SEARCH_TAB_HEADING = '"Assault" Search results';

    const // each document link in the left hand list
      $menuLinks = $(".openMe a"),
      // the root of the tabs control
      $tabList = $(".govuk-tabs .govuk-tabs__list"),
      // links appearing in the modal-style search results
      $modalLinks = $("#searchModal .mb5 a"),
      // search field
      $inpSearchUrn = $("#inpSearchURN"),
      // search field button
      $btnSearchUrn = $("#btnSearchURN");

    $menuLinks.each(function (_, link) {
      $(link).click(function (event) {
        event.preventDefault();
        handleMenuLinkClick($(this).text());
      });
    });

    $modalLinks.each(function (_, link) {
      $(link).click(function (event) {
        event.preventDefault();
        handleMenuLinkClick($(this).text());
      });
    });

    $inpSearchUrn.keyup(function (e) {
      if (e.key === "Enter") alert("hi");
    });

    $btnSearchUrn.click(function (e) {
      alert("hi");
    });

    function handleMenuLinkClick(label) {
      highlightMenuLink(label, true);
      ensureTabExists(label);
      showTab(label, true);
      $("#searchModal").addClass("rj-dont-display");
    }

    function highlightMenuLink(label, isHighlighted) {
      const $link = $(`.openMe a:contains("${label}")`);
      if (isHighlighted) {
        $link.parent("td").addClass("documentSelected");
      } else {
        $link.parent("td").removeClass("documentSelected");
      }
    }

    function ensureTabExists(label) {
      const document = $(`.openMe a:contains("${label}")`).attr("data-doc");
      const existingTab = $(`li[data-tab-id='${label}']`);
      if (existingTab.length) return;

      const newTab = $(`
        <li class="govuk-tabs__list-item" data-tab-id="${label}">

            <svg class="closeButtonOnCPS">
                <circle cx="12" cy="12" r="13" stroke="white" stroke-width="1" fill="white" />
                <path stroke="white" stroke-width="3" fill="none" d="M6.25,6.25,17.75,17.75" />
                <path stroke="white" stroke-width="3" fill="none" d="M6.25,17.75,17.75,6.25" />
            </svg>

            <a class="govuk-tabs__tab" href="">${label}</a>
        </li>`).appendTo($tabList);

      const newContent = $(`
        <div class="govuk-tabs__panel govuk-tabs__panel--hidden" style="padding-top: 15px !important;  background: #1d70b8;" data-tab-id="${label}-content">  
            <!-- start of search results -->
                <div style="display:flex">
                <p class="govuk-body-s inPageSearchMargins" style="padding-left:20px; font-weight:700; max-width:600px">We've found 3 matchs for "assault" in ${label} </p>
                <p class="govuk-body-s inPageSearchMargins  deactivatedPrevious" style="margin-left:auto; margin-right:10px">Previous</p>
                <p class="govuk-body-s inPageSearchMargins" style="margin-right:10px; font-weight:700">1/3</p>
                <p class="govuk-body-s inPageSearchMargins looks-like-a-link-underline" style="margin-right:20px">Next</p>
                </div> 
            <!-- end of search results -->
            <embed class="embedSize" src="/public/files/${document}#toolbar=0" >
        </div>`).insertAfter($tabList);

      newTab.find("li").off("click");
      newTab.find("a.govuk-tabs__tab").click(function () {
        event.preventDefault();
        showTab(label);
      });

      newTab.find(".closeButtonOnCPS").click(function () {
        destroyTab(label);
        highlightMenuLink(label, false);
      });
    }

    function destroyTab(label) {
      const $tabs = $(`li[data-tab-id`);
      const $thisTab = $(`li[data-tab-id='${label}']`);
      const thisTabIndex = $tabs.index($thisTab);
      const tabIndexToLeaveOpen = thisTabIndex
        ? thisTabIndex - 1 // if not first tab, go to the left
        : 0; // otherwise if first tab, then go to the tab that is now first
      $(`li[data-tab-id='${label}']`).remove();
      $(`div[data-tab-id='${label}-content']`).remove();

      const labelOfTabToOpen = $($(`li[data-tab-id`)[tabIndexToLeaveOpen])
        .text()
        .trim();

      showTab(labelOfTabToOpen);
    }

    function showTab(label) {
      $tabList.find("li").removeAttr("id", "selectedTab");
      $tabList.find("li").removeClass("govuk-tabs__list-item--selected");

      $(`li[data-tab-id='${label}']`).addClass(
        "govuk-tabs__list-item--selected"
      );
      $(`li[data-tab-id='${label}']`).attr("id", "selectedTab");

      $(".govuk-tabs__panel").addClass("govuk-tabs__panel--hidden");
      $(`div[data-tab-id='${label}-content']`).removeClass(
        "govuk-tabs__panel--hidden"
      );

      const selectedTab = $("#selectedTab");
      if (selectedTab.length) {
        selectedTab[0].scrollIntoView();
      }
    }

    function showTab(label) {
      $tabList.find("li").removeAttr("id", "selectedTab");
      $tabList.find("li").removeClass("govuk-tabs__list-item--selected");

      $(`li[data-tab-id='${label}']`).addClass(
        "govuk-tabs__list-item--selected"
      );
      $(`li[data-tab-id='${label}']`).attr("id", "selectedTab");

      $(".govuk-tabs__panel").addClass("govuk-tabs__panel--hidden");
      $(`div[data-tab-id='${label}-content']`).removeClass(
        "govuk-tabs__panel--hidden"
      );

      const selectedTab = $("#selectedTab");
      if (selectedTab.length) {
        selectedTab[0].scrollIntoView();
      }
    }
  });

  function openSearchTab() {
    alert("hi");
  }
</script>
